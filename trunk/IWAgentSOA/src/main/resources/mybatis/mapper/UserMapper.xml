<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.manyi.iw.soa.mapper.UserMapper">
  <resultMap id="BaseResultMap" type="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="mobile" jdbcType="VARCHAR" property="mobile" />
    <result column="mobile_sn" jdbcType="VARCHAR" property="mobileSn" />
    <result column="password" jdbcType="VARCHAR" property="password" />
    <result column="real_name" jdbcType="VARCHAR" property="realName" />
    <result column="gender" jdbcType="TINYINT" property="gender" />
    <result column="agent_id" jdbcType="BIGINT" property="agentId" />
    <result column="last_login_time" jdbcType="TIMESTAMP" property="lastLoginTime" />
    <result column="user_type" jdbcType="TINYINT" property="userType" />
    <result column="sys_status" jdbcType="TINYINT" property="sysStatus" />
    <result column="biz_status" jdbcType="TINYINT" property="bizStatus" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    <result column="memo" jdbcType="LONGVARCHAR" property="memo" />
  </resultMap>
  <resultMap type="com.manyi.iw.soa.user.model.UserSearchResponse" id="User_StatisticsResultMap">
  	<id column="id" property="id" jdbcType="BIGINT" />
  	<result column="mobile" property="mobile" jdbcType="VARCHAR" />
  	<result column="real_name" property="realName" jdbcType="VARCHAR" />
  	<result column="gender" property="gender" jdbcType="VARCHAR" />
  	<result column="last_login_time" property="lastLoginTime" jdbcType="TIMESTAMP" />
  	<result column="agent_id" property="agentId" jdbcType="BIGINT" />
  	<result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
	<result column="applyed_num" property="applyedNum" jdbcType="INTEGER" />
    <result column="saw_num" property="sawNum" jdbcType="INTEGER" />
    <result column="inchart_num" property="inchartNum" jdbcType="INTEGER" />
    <result column="biz_status" property="bizStatus" jdbcType="INTEGER" />
    <result column="recommend_num" property="recommendNum" jdbcType="INTEGER" />
    <result column="waitdeal_num" property="waitdealNum" jdbcType="INTEGER" />
    <result column="collection_num" property="collectionNum" jdbcType="INTEGER" />
  </resultMap>

  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    id, mobile, mobile_sn, real_name, gender, agent_id, last_login_time, user_type, 
    sys_status, biz_status, update_time, create_time
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    memo
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="ResultMapWithBLOBs">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from iw_user
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    delete from iw_user
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    insert into iw_user (id, mobile, mobile_sn, 
      password, real_name, gender, 
      agent_id, last_login_time, user_type, 
      sys_status, biz_status, update_time, 
      create_time, memo)
    values (#{id,jdbcType=BIGINT}, #{mobile,jdbcType=VARCHAR}, #{mobileSn,jdbcType=VARCHAR}, 
      #{password,jdbcType=VARCHAR}, #{realName,jdbcType=VARCHAR}, #{gender,jdbcType=TINYINT}, 
      #{agentId,jdbcType=BIGINT}, #{lastLoginTime,jdbcType=TIMESTAMP}, #{userType,jdbcType=TINYINT}, 
      #{sysStatus,jdbcType=TINYINT}, #{bizStatus,jdbcType=TINYINT}, #{updateTime,jdbcType=TIMESTAMP}, 
      #{createTime,jdbcType=TIMESTAMP}, #{memo,jdbcType=LONGVARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    insert into iw_user
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="mobile != null">
        mobile,
      </if>
      <if test="mobileSn != null">
        mobile_sn,
      </if>
      <if test="password != null">
        password,
      </if>
      <if test="realName != null">
        real_name,
      </if>
      <if test="gender != null">
        gender,
      </if>
      <if test="agentId != null">
        agent_id,
      </if>
      <if test="lastLoginTime != null">
        last_login_time,
      </if>
      <if test="userType != null">
        user_type,
      </if>
      <if test="sysStatus != null">
        sys_status,
      </if>
      <if test="bizStatus != null">
        biz_status,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="memo != null">
        memo,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="mobile != null">
        #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="mobileSn != null">
        #{mobileSn,jdbcType=VARCHAR},
      </if>
      <if test="password != null">
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="realName != null">
        #{realName,jdbcType=VARCHAR},
      </if>
      <if test="gender != null">
        #{gender,jdbcType=TINYINT},
      </if>
      <if test="agentId != null">
        #{agentId,jdbcType=BIGINT},
      </if>
      <if test="lastLoginTime != null">
        #{lastLoginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="userType != null">
        #{userType,jdbcType=TINYINT},
      </if>
      <if test="sysStatus != null">
        #{sysStatus,jdbcType=TINYINT},
      </if>
      <if test="bizStatus != null">
        #{bizStatus,jdbcType=TINYINT},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="memo != null">
        #{memo,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    update iw_user
    <set>
      <if test="mobile != null">
        mobile = #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="mobileSn != null">
        mobile_sn = #{mobileSn,jdbcType=VARCHAR},
      </if>
      <if test="password != null">
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="realName != null">
        real_name = #{realName,jdbcType=VARCHAR},
      </if>
      <if test="gender != null">
        gender = #{gender,jdbcType=TINYINT},
      </if>
      <if test="agentId != null">
        agent_id = #{agentId,jdbcType=BIGINT},
      </if>
      <if test="lastLoginTime != null">
        last_login_time = #{lastLoginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="userType != null">
        user_type = #{userType,jdbcType=TINYINT},
      </if>
      <if test="sysStatus != null">
        sys_status = #{sysStatus,jdbcType=TINYINT},
      </if>
      <if test="bizStatus != null">
        biz_status = #{bizStatus,jdbcType=TINYINT},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="memo != null">
        memo = #{memo,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    update iw_user
    set mobile = #{mobile,jdbcType=VARCHAR},
      mobile_sn = #{mobileSn,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      real_name = #{realName,jdbcType=VARCHAR},
      gender = #{gender,jdbcType=TINYINT},
      agent_id = #{agentId,jdbcType=BIGINT},
      last_login_time = #{lastLoginTime,jdbcType=TIMESTAMP},
      user_type = #{userType,jdbcType=TINYINT},
      sys_status = #{sysStatus,jdbcType=TINYINT},
      biz_status = #{bizStatus,jdbcType=TINYINT},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      memo = #{memo,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.manyi.iw.soa.entity.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 17 17:40:19 CST 2014.
    -->
    update iw_user
    set mobile = #{mobile,jdbcType=VARCHAR},
      mobile_sn = #{mobileSn,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      real_name = #{realName,jdbcType=VARCHAR},
      gender = #{gender,jdbcType=TINYINT},
      agent_id = #{agentId,jdbcType=BIGINT},
      last_login_time = #{lastLoginTime,jdbcType=TIMESTAMP},
      user_type = #{userType,jdbcType=TINYINT},
      sys_status = #{sysStatus,jdbcType=TINYINT},
      biz_status = #{bizStatus,jdbcType=TINYINT},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <resultMap id="User_Statistics_ResultMap" type="com.manyi.iw.soa.user.model.UserSearchRequest">
  	<id column="id" jdbcType="BIGINT" property="id" />
  	<result column="mobile" jdbcType="VARCHAR" property="mobile" />
  	<result column="real_name" jdbcType="VARCHAR" property="realName" />
  	<result column="last_login_time" jdbcType="BIGINT" property="lastLoginTime" />
  	<result column="agent_id" jdbcType="BIGINT" property="agentId" />
  	<result column="create_time" jdbcType="BIGINT" property="createTime" />
  	<association javaType="com.manyi.iw.soa.entity.UserStatistics" property="userStatistics">
  		<result column="applyed_num" jdbcType="INTEGER" property="applyedNum" />
	    <result column="saw_num" jdbcType="INTEGER" property="sawNum" />
	    <result column="inchart_num" jdbcType="INTEGER" property="inchartNum" />
	    <result column="recommend_num" jdbcType="INTEGER" property="recommendNum" />
	    <result column="waitdeal_num" jdbcType="INTEGER" property="waitdealNum" />
	    <result column="collection_num" jdbcType="INTEGER" property="collectionNum" />
  	</association>
  </resultMap>
  
  
  <sql id="userListWhere">
  	where 1=1 
  		<if test="realName != null">
  			and real_name like concat('%',#{realName,jdbcType=VARCHAR},'%') 
  		</if> 
  		<if test="gender != null and gender != 0">
  			and gender = #{gender,jdbcType=TINYINT} 
  		</if>
  		<if test="mobile != null">
  			and mobile like concat('%',#{mobile,jdbcType=VARCHAR},'%') 
  		</if>
  		<if test="bizStatus != null and bizStatus != -1">
  			and biz_status = #{bizStatus,jdbcType=TINYINT} 
  		</if>
  		<if test="minLastLoginTime != null">
  			and last_login_time &gt; #{minLastLoginTime,jdbcType=TIMESTAMP}
  		</if>
  		<if test="maxLastLoginTime != null">
  			and last_login_time &lt; #{maxLastLoginTime,jdbcType=TIMESTAMP}
  		</if>
  		<choose>
  			<when test="collectionNum == 1">
  				and iwus.collection_num &gt;0
  			</when>
  			<when test="collectionNum == 2">
  				and iwus.collection_num = 0
  			</when>
  		</choose>
  		<choose>
  			<when test="sawNum == 1">
  				and iwus.saw_num &gt;0
  			</when>
  			<when test="sawNum == 2">
  				and iwus.saw_num = 0
  			</when>
  		</choose>
  		<choose>
  			<when test="inchartNum == 1">
  				and iwus.inchart_num &gt;0
  			</when>
  			<when test="inchartNum == 2">
  				and iwus.inchart_num = 0
  			</when>
  		</choose>
  		<choose>
  			<when test="recommendNum == 1">
  				and iwus.recommend_num &gt;0
  			</when>
  			<when test="recommendNum == 2">
  				and iwus.recommend_num = 0
  			</when>
  		</choose>
  		<choose>
  			<when test="waitdealNum == 1">
  				and iwus.waitdeal_num &gt;0
  			</when>
  			<when test="waitdealNum == 2">
  				and iwus.waitdeal_num = 0
  			</when>
  		</choose>
  		<!-- 排除掉被删除的用户 -->
  		and sys_status != 2
  </sql>
  
  <select id="getUserListTotal" resultType="int">
  	select count(0) from iw_user iwu left join iw_user_statistics iwus on iwu.id = iwus.user_id
  	<include refid="userListWhere"/> 
  </select>
  
  
  <!-- 用户查询列表页面（包含统计数据） -->
  <select id="getUserList" resultMap="User_StatisticsResultMap" parameterType="com.manyi.iw.soa.user.model.UserSearchRequest">
  	select 
  		iwu.id,real_name,gender,mobile,applyed_num, agent_id,saw_num, inchart_num, recommend_num, waitdeal_num, collection_num,biz_status,iwu.create_time,last_login_time
  	from iw_user iwu left join iw_user_statistics iwus on iwu.id = iwus.user_id
  	<include refid="userListWhere"/>
  		${additionalSql}
  </select>
  
  <!-- 修改用户的业务状态 -->
  <update id="editBizStatus" parameterType="com.manyi.iw.soa.user.model.UserEditBizStatusModel">
  	update iw_user set biz_status = #{bizStatus,jdbcType=TINYINT},memo = #{memo,jdbcType=VARCHAR}
  	where id = #{userId,jdbcType=BIGINT}
  </update>
  
  <!-- 将用户类型从新用户改为老用户（前提是该用户已经看房成功） -->
  <update id="updateUserType">
  	update iw_user set user_type = 1 where id in (
		select user_id from iw_user_statistics where user_id = #{userId,jdbcType=BIGINT} and saw_num > 0
	)
  	
  </update>
  
</mapper>