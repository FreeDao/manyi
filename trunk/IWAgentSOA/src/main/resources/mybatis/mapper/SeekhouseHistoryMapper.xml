<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.manyi.iw.soa.mapper.SeekhouseHistoryMapper" >
  <resultMap id="BaseResultMap" type="com.manyi.iw.soa.entity.SeekhouseHistory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="appointment_id" property="appointmentId" jdbcType="BIGINT" />
    <result column="agent_id" property="agentId" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="house_id" property="houseId" jdbcType="BIGINT" />
    <result column="state" property="state" jdbcType="TINYINT" />
    <result column="memo" property="memo" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    id, appointment_id, agent_id, user_id, house_id, state, memo, update_time, create_time
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from iw_seekhouse
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >

    delete from iw_seekhouse
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.manyi.iw.soa.entity.SeekhouseHistory" >

    insert into iw_seekhouse (id, appointment_id, agent_id, 
      user_id, house_id, state, 
      memo, update_time, create_time
      )
    values (#{id,jdbcType=BIGINT}, #{appointmentId,jdbcType=BIGINT}, #{agentId,jdbcType=BIGINT}, 
      #{userId,jdbcType=BIGINT}, #{houseId,jdbcType=BIGINT}, #{state,jdbcType=TINYINT}, 
      #{memo,jdbcType=VARCHAR}, #{updateTime,jdbcType=TIMESTAMP}, #{createTime,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.manyi.iw.soa.entity.SeekhouseHistory" >

    insert into iw_seekhouse
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="appointmentId != null" >
        appointment_id,
      </if>
      <if test="agentId != null" >
        agent_id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="houseId != null" >
        house_id,
      </if>
      <if test="state != null" >
        state,
      </if>
      <if test="memo != null" >
        memo,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="appointmentId != null" >
        #{appointmentId,jdbcType=BIGINT},
      </if>
      <if test="agentId != null" >
        #{agentId,jdbcType=BIGINT},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=BIGINT},
      </if>
      <if test="houseId != null" >
        #{houseId,jdbcType=BIGINT},
      </if>
      <if test="state != null" >
        #{state,jdbcType=TINYINT},
      </if>
      <if test="memo != null" >
        #{memo,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.manyi.iw.soa.entity.SeekhouseHistory" >
    update iw_seekhouse
    <set >
      <if test="appointmentId != null" >
        appointment_id = #{appointmentId,jdbcType=BIGINT},
      </if>
      <if test="agentId != null" >
        agent_id = #{agentId,jdbcType=BIGINT},
      </if>
      <if test="userId != null" >
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="houseId != null" >
        house_id = #{houseId,jdbcType=BIGINT},
      </if>
      <if test="state != null" >
        state = #{state,jdbcType=TINYINT},
      </if>
      <if test="memo != null" >
        memo = #{memo,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.manyi.iw.soa.entity.SeekhouseHistory" >
    update iw_seekhouse
    set appointment_id = #{appointmentId,jdbcType=BIGINT},
      agent_id = #{agentId,jdbcType=BIGINT},
      user_id = #{userId,jdbcType=BIGINT},
      house_id = #{houseId,jdbcType=BIGINT},
      state = #{state,jdbcType=TINYINT},
      memo = #{memo,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
   <insert id="saveSeekhouseHistories">
    	insert into iw_seekhouse_history (house_id,state,appointment_id,create_time) values
	<foreach collection="list" item="m" index="index" separator=",">
	      (#{m.houseId},#{m.state},#{m.appointmentId},now())
	</foreach>
	;
   </insert>
    <update id="updateHouseHistoryStateById">
              update iw_seekhouse_history set state=#{state},memo=#{memo} ,nosaw_reason=#{nosawReason}
              where id= #{id}
             ;
   </update>
   
    <select id="getseekhouseIdByKey" resultType="java.lang.Long">
              select  a.id from  iw_seekhouse a,iw_seekhouse_history b where a.appointment_id=b.appointment_id and a.house_id=b.house_id
               and  b.id= #{id}
             ;
   </select>
   
    <select id="getSeeHouseHistoryByAppointmentId"  resultType="com.manyi.iw.soa.seekhouse.model.SeeHouseVo">
			SELECT
			    a.id as id,
			    a.memo,
				a.house_id AS houseId,
				e.`name` AS bankuai,
				d.`name` AS xiaoqu,
				b.room AS fanghao,
				g.appointment_time as seeHouseTime,
				e.path as path,
				a.state as state,
				CONCAT(
					b.bedroomSum,
					'室',
					b.livingRoomSum,
					'厅',
					b.wcSum,
					'卫',
					b.balconySum,
					'阳台'
				) AS huxing,
				c.rentPrice AS jiage,
				group_CONCAT(
					f.hostName,
					f.hostMobile SEPARATOR '/'
				) AS lianxifs
			FROM
				iw_seekhouse_history a LEFT JOIN house b on a.house_id=b.houseId
		        LEFT JOIN houseresource c on a.house_id=c.houseId
		        LEFT JOIN area d ON b.estateId=d.areaId
		        LEFT JOIN area e ON d.parentId=e.areaId
		        LEFT JOIN houseresourcecontact f ON  a.house_id=f.houseId
		        LEFT JOIN iw_appointment g ON a.appointment_id=g.id
			WHERE
				 g.agent_id = #{agentId}
			     AND a.appointment_id=#{appointmentId}
			  GROUP BY
				a.house_id;
  </select>
  
  <update id="updateHouseHistoryStateByHouseId">
        update iw_seekhouse_history a set a.state=#{state} where house_id=#{houseId}
  </update>
  
  <update id="updateHouseHistoryStateByappointmentId">
         update iw_seekhouse_history a set a.state=#{state} where appointment_id=#{appointmentId}
  </update>
</mapper>