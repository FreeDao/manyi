<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.manyi.iw.soa.mapper.AgentMapper" >
  <resultMap id="BaseResultMap" type="com.manyi.iw.soa.entity.Agent" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="uname" property="name" jdbcType="VARCHAR" />
    <result column="serial_number" property="serialNumber" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="mobile" property="mobile" jdbcType="VARCHAR" />
    <result column="photo_url" property="photoUrl" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="memo" property="memo" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="TINYINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    id, uname, serial_number, mobile, photo_url, update_time, create_time, memo, 
    status
  </sql>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from iw_agent
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    delete from iw_agent
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.manyi.iw.soa.entity.Agent" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    insert into iw_agent (id, uname, serial_number, 
      password, mobile, photo_url, 
      update_time, create_time, memo, 
      status)
    values (#{id,jdbcType=BIGINT}, #{name,jdbcType=VARCHAR}, #{serialNumber,jdbcType=VARCHAR}, 
      #{password,jdbcType=VARCHAR}, #{mobile,jdbcType=VARCHAR}, #{photoUrl,jdbcType=VARCHAR}, 
      #{updateTime,jdbcType=TIMESTAMP}, #{createTime,jdbcType=TIMESTAMP}, #{memo,jdbcType=VARCHAR}, 
      #{status,jdbcType=TINYINT})
  </insert>
  <insert id="insertSelective" parameterType="com.manyi.iw.soa.entity.Agent" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    insert into iw_agent
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="name != null" >
        uname,
      </if>
      <if test="serialNumber != null" >
        serial_number,
      </if>
      <if test="password != null" >
        password,
      </if>
      <if test="mobile != null" >
        mobile,
      </if>
      <if test="photoUrl != null" >
        photo_url,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="memo != null" >
        memo,
      </if>
      <if test="status != null" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="name != null" >
        #{uname,jdbcType=VARCHAR},
      </if>
      <if test="serialNumber != null" >
        #{serialNumber,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="mobile != null" >
        #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="photoUrl != null" >
        #{photoUrl,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="memo != null" >
        #{memo,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.manyi.iw.soa.entity.Agent" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    update iw_agent
    <set >
      <if test="name != null" >
        uname = #{name,jdbcType=VARCHAR},
      </if>
      <if test="serialNumber != null" >
        serial_number = #{serialNumber,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="mobile != null" >
        mobile = #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="photoUrl != null" >
        photo_url = #{photoUrl,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="memo != null" >
        memo = #{memo,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.manyi.iw.soa.entity.Agent" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 16 18:57:25 CST 2014.
    -->
    update iw_agent
    set uname = #{name,jdbcType=VARCHAR},
      serial_number = #{serialNumber,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      mobile = #{mobile,jdbcType=VARCHAR},
      photo_url = #{photoUrl,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      memo = #{memo,jdbcType=VARCHAR},
      status = #{status,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <!-- 使用手机号、密码进行登录获取经纪人的信息  author：carvink -->
  <select id="login" resultMap="BaseResultMap">
  	select 
  		<include refid="Base_Column_List"/>
  	from iw_agent
  	where 
  		mobile = #{mobile,jdbcType=VARCHAR} and password = #{password,jdbcType=VARCHAR}
  </select>
 <select id="getAgentUnproc" parameterType="map" resultType="com.manyi.iw.soa.agent.model.AgentUnprocModel">
	SELECT
		iw_user.mobile,
		iw_user.real_name as realname,
		iw_user.gender,
		iw_user.user_type as userType,
		iw_user.last_login_time as lastLoginTime,
		iw_user.id as userId,
		count(iw_user.id) as unprocCount
	FROM
		iw_user
	LEFT JOIN iw_seekhouse iw_sh ON iw_sh.user_id = iw_user.id
	WHERE
	 state IN (1, 2, 7, 8)
	<if test="userType != null and userType != '-1'" >
	AND user_type = #{userType}
	</if>
	AND	iw_sh.agent_id = #{agentId}
	GROUP BY
		iw_user.id
 </select>
 
 <sql id="seekHouseCondition">
 	where iw_sh.agent_id=#{agentId} 
		<choose>
			<when test="town != null and town != 0">
				and a.areaId = #{town,jdbcType=INTEGER}
			</when>
			<otherwise>
				<if test="district != null and district != 0">
					and b.areaId = #{district,jdbcType=INTEGER} 
				</if>
			</otherwise>
		</choose>
		<if test="estateName != null and estateName != ''">
			and es.`name` like concat('%',#{estateName,jdbcType=VARCHAR},'%') 
		</if>
		<!-- 装修 -->
		<if test="decorateType != null and decorateType != 0">
			and house.decorateType = #{decorateType,jdbcType=INTEGER}
		</if>
		<!-- 户型 -->
		<!-- 厅数 -->
		<if test="livingRoomSum != null and livingRoomSum != 0">
			and house.livingRoomSum = #{livingRoomSum,jdbcType=INTEGER}
		</if>
		<!-- 房数 -->
		<if test="bedroomSum != null and bedroomSum != 0">
			and house.bedroomSum = #{bedroomSum,jdbcType=INTEGER}
		</if>
		<!-- 卫数 -->
		<if test="wcSum != null and wcSum != 0">
			and house.wcSum = #{wcSum,jdbcType=INTEGER}
		</if>
		<!-- 最低价格 -->
		<if test="minPrice != null">
			and hr.rentPrice &gt; #{minPrice,jdbcType=DECIMAL}
		</if>
		<!-- 最高价格 -->
		<if test="maxPrice != null">
			and hr.rentPrice &lt; #{maxPrice,jdbcType=DECIMAL}
		</if>
		<if test="createTimeStart != null">
			and iw_sh.create_time &gt; #{createTimeStart}
		</if>
		<if test="createTimeEnd != null">
			and iw_sh.create_time &lt; #{createTimeEnd}
		</if>
		<if test="userType != null and userType !=-1">
			and iw_user.user_type = #{userType}
		</if>
		<if test="mobile != null and mobile != ''">
			and iw_user.mobile = #{mobile}
		</if>
		<if test="realname != null and realname != ''">
			and iw_user.real_name = #{realname}
		</if>
		<if test="gender != null and gender != -1">
			and iw_user.gender = #{gender}
		</if>
		<if test="state != null and state != 0">
			and iw_sh.state = #{state}
		</if>
 </sql>
 
 
 <select id="getAgentAllSeekHouse" parameterType="com.manyi.iw.soa.agent.model.AgentSeekHouseRequest" resultType="com.manyi.iw.soa.agent.model.AgentSeekHouseModel">
		 SELECT
			iw_user.real_name as realname,
			iw_user.gender,
			iw_user.mobile,
			iw_user.user_type as userType,
			es.`name` as estate,
			a.`name` as town,
		  b.`name` as district,
		  house.building,
		  house.room,
		  house.bedroomSum,
		  house.livingRoomSum,
		  house.wcSum,
		  house.floor,
		  hr.rentPrice,
		  iw_sh.create_time as createTime,
			iw_sh.state,
		  iw_user.id as userId
		FROM
		iw_seekhouse AS iw_sh
		LEFT JOIN iw_user ON iw_sh.user_id = iw_user.id
		LEFT JOIN house ON iw_sh.house_Id = house.houseId
		LEFT JOIN houseresource as hr ON hr.houseId = iw_sh.house_Id
		LEFT JOIN area es ON house.estateId = es.areaId
		LEFT JOIN area a ON a.areaId = es.parentId
		LEFT JOIN area b ON b.areaId = a.parentId
 		<include refid="seekHouseCondition"/>
 		${additionalSql}
 </select>
 
 <select id="getAgentAllSeekHouseTotal"  parameterType="com.manyi.iw.soa.agent.model.AgentSeekHouseRequest" resultType="int">
 	 SELECT
		count(1)
		FROM
		iw_seekhouse AS iw_sh
		LEFT JOIN iw_user ON iw_sh.user_id = iw_user.id
		LEFT JOIN house ON iw_sh.house_Id = house.houseId
		LEFT JOIN houseresource as hr ON hr.houseId = iw_sh.house_Id
		LEFT JOIN area es ON house.estateId = es.areaId
		LEFT JOIN area a ON a.areaId = es.parentId
		LEFT JOIN area b ON b.areaId = a.parentId
 		<include refid="seekHouseCondition"/>
 </select>
</mapper>